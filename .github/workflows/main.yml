name: Build TWRP Recovery

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        continue-on-error: true

      - name: Install essential dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y -q bc bison build-essential curl flex g++-multilib gcc-multilib git gnupg gperf \
            imagemagick libncurses5-dev lib32z1-dev liblz4-tool libsdl1.2-dev libssl-dev \
            libxml2 libxml2-utils lzop openjdk-11-jdk python3 python3-pip unzip xz-utils zip zlib1g-dev \
            repo
        continue-on-error: true

      - name: Set up repo and sync sources
        run: |
          mkdir -p ~/twrp && cd ~/twrp
          repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-12.1
          repo sync -j$(nproc) --force-sync
        continue-on-error: true

      - name: Clone device tree
        run: |
          mkdir -p ~/twrp/device/oneplus/larry
          git clone https://github.com/LineageOS/android_device_oneplus_larry ~/twrp/device/oneplus/larry
        continue-on-error: true

      - name: Set up build environment
        run: |
          cd ~/twrp
          source build/envsetup.sh
          export ALLOW_MISSING_DEPENDENCIES=true
          lunch twrp_larry-eng
        continue-on-error: true

      - name: Build TWRP
        run: |
          cd ~/twrp
          mka bootimage vendor_bootimage dtboimage recoveryimage
        continue-on-error: true

      - name: Upload images as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: twrp-images
          path: |
            ~/twrp/out/target/product/larry/boot.img
            ~/twrp/out/target/product/larry/vendor_boot.img
            ~/twrp/out/target/product/larry/dtbo.img
            ~/twrp/out/target/product/larry/recovery.img
        continue-on-error: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ~/twrp/out/target/product/larry/boot.img
            ~/twrp/out/target/product/larry/vendor_boot.img
            ~/twrp/out/target/product/larry/dtbo.img
            ~/twrp/out/target/product/larry/recovery.img
          tag_name: latest
          name: TWRP Build for OnePlus Larry
          body: |
            Latest TWRP build for OnePlus Larry
            
            - Boot Image
            - Vendor Boot Image
            - DTBO Image
            - Recovery Image
          draft: false
          prerelease: false
        continue-on-error: true
